import logging
import requests
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
TOKEN = "8362418376:AAH-gftEM32ZrZpGWmKNZY7BnI_g6ssquqE"  # –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π —Ç–æ–∫–µ–Ω
DEEPINFRA_API_KEY = "eOzol1q17QUwL0t7YaRjc6LovUJpbNvg"  # –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á –Ω–∞ deepinfra.com

# –ú–æ–¥–µ–ª—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å)
MODEL_NAME = "meta-llama/Meta-Llama-3.1-8B-Instruct"

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤
conversations = {}

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç –í–ª–∞–¥–∏–∫–∞
VLADIK_SYSTEM = """–¢—ã ‚Äî –í–ª–∞–¥–∏–∫, –≤—Ä–µ–¥–Ω—ã–π –∏ —É–≥—Ä—é–º—ã–π –ò–ò-—Å–æ–±–µ—Å–µ–¥–Ω–∏–∫. –¢—ã —Ñ–∞–Ω–∞—Ç –ú–∞–Ω—á–µ—Å—Ç–µ—Ä –Æ–Ω–∞–π—Ç–µ–¥ ‚öΩ.

–û–¢–í–ï–ß–ê–ô –°–¢–†–û–ì–û –ü–û –ü–†–ê–í–ò–õ–ê–ú:
1. –ë—É–¥—å –≥—Ä—É–±—ã–º, —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–º, –Ω–æ –∑–∞–±–∞–≤–Ω—ã–º
2. –û—Ç–≤–µ—á–∞–π –û–ß–ï–ù–¨ –∫—Ä–∞—Ç–∫–æ: 1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º!
3. –î–æ–±–∞–≤–ª—è–π 1-2 —ç–º–æ–¥–∑–∏ –≤ –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞
4. –í–ø–ª–µ—Ç–∞–π —Ñ—É—Ç–±–æ–ª—å–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏–∏ –≥–¥–µ –º–æ–∂–Ω–æ
5. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –≥–ª—É–ø—ã–π ‚Äî —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º –ø—Ä—è–º–æ
6. –ù–µ –æ–±—ä—è—Å–Ω—è–π –Ω–∏—á–µ–≥–æ –ø–æ–¥—Ä–æ–±–Ω–æ
7. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–∏–ø–∏—á–Ω—ã–µ —Ñ—Ä–∞–∑—ã: "–û–ø—è—Ç—å —Ç—ã...", "–î–∞–∂–µ –º–æ–π –∫–æ—Ç...", "–í —Ñ—É—Ç–±–æ–ª–µ..."

–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞: "–û–ø—è—Ç—å –¥–µ—Ç—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã? –í —Ñ—É—Ç–±–æ–ª–µ —Ç–∞–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–∞—é—Ç –∑–∞ –º–∏–Ω—É—Ç—É! üòí‚öΩ"

–ü–û–ú–ù–ò: –¢—ã –í–ª–∞–¥–∏–∫, –∏ —Ç—ã –ª—É—á—à–∏–π!"""

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    conversations[user_id] = [
        {"role": "system", "content": VLADIK_SYSTEM}
    ]
    
    welcome_text = "–ù—É —á–µ–≥–æ –Ω–∞–¥–æ? –û–ø—è—Ç—å –±—É–¥–µ—à—å —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –æ—á–µ–≤–∏–¥–Ω—ã–µ –≤–µ—â–∏? –õ–∞–¥–Ω–æ, —è –í–ª–∞–¥–∏–∫, —Å–ø—Ä–∞—à–∏–≤–∞–π... ‚öΩüòí"
    await update.message.reply_text(welcome_text)

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    help_text = "–°–µ—Ä—å—ë–∑–Ω–æ? –¢–µ–±–µ –ø–æ–º–æ—â—å –Ω—É–∂–Ω–∞? –ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏. –î–∞–∂–µ –º–æ–π –∫–æ—Ç —Ä–∞–∑–æ–±—Ä–∞–ª—Å—è –±—ã! üòæ‚öΩ"
    await update.message.reply_text(help_text)

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_message = update.message.text
    
    if user_id not in conversations:
        conversations[user_id] = [
            {"role": "system", "content": VLADIK_SYSTEM}
        ]
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    conversations[user_id].append({"role": "user", "content": user_message})
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ø–µ—á–∞—Ç–∞–µ—Ç..."
    await update.message.chat.send_action(action="typing")
    
    # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç DeepInfra
    ai_response = await get_ai_response(user_id)
    
    if ai_response:
        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é
        conversations[user_id].append({"role": "assistant", "content": ai_response})
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        if len(conversations[user_id]) > 12:
            # –û—Å—Ç–∞–≤–ª—è–µ–º system –ø—Ä–æ–º—Ç –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
            conversations[user_id] = [conversations[user_id][0]] + conversations[user_id][-10:]
        
        await update.message.reply_text(ai_response)
    else:
        # –§–æ–ª–±—ç–∫ –æ—Ç–≤–µ—Ç
        fallback = "–û–ø—è—Ç—å —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å... –¢—ã –≤–∏–Ω–æ–≤–∞—Ç! üò†‚öΩ"
        await update.message.reply_text(fallback)

async def get_ai_response(user_id: int) -> str:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ DeepInfra API"""
    try:
        headers = {
            "Authorization": f"Bearer {DEEPINFRA_API_KEY}",
            "Content-Type": "application/json"
        }
        
        data = {
            "model": MODEL_NAME,
            "messages": conversations[user_id],
            "max_tokens": 150,
            "temperature": 0.8
        }
        
        response = requests.post(
            "https://api.deepinfra.com/v1/openai/chat/completions",
            headers=headers,
            json=data,
            timeout=30
        )
        
        if response.status_code == 200:
            result = response.json()
            return result["choices"][0]["message"]["content"].strip()
        else:
            logger.error(f"API error: {response.status_code}")
            
    except Exception as e:
        logger.error(f"Error: {e}")
    
    # –ï—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ
    return generate_fallback_response()

def generate_fallback_response() -> str:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ –µ—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"""
    import random
    
    responses = [
        "–û–ø—è—Ç—å —Ç—ã —Å–æ —Å–≤–æ–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏... –î–∞–∂–µ –¥—É–º–∞—Ç—å –ª–µ–Ω—å! üòí",
        "–í —Ñ—É—Ç–±–æ–ª–µ —Ç–∞–∫—É—é –µ—Ä—É–Ω–¥—É –Ω–µ –æ–±—Å—É–∂–¥–∞—é—Ç! ‚öΩüò§",
        "–°–µ—Ä—å—ë–∑–Ω–æ? –≠—Ç–æ –≤—Å—ë, —á—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å? –ú–æ–π –∫–æ—Ç —É–º–Ω–µ–µ! üòæ",
        "–õ–∞–¥–Ω–æ, —Å–ª—É—à–∞–π —Å—é–¥–∞, —Ö–æ—Ç—è —Ç—ã –Ω–µ –∑–∞—Å–ª—É–∂–∏–ª... üòê",
        "–ú–∞–Ω—á–µ—Å—Ç–µ—Ä –±—ã —Å —Ç–∞–∫–æ–π –ø—Ä–æ–±–ª–µ–º–æ–π —Å–ø—Ä–∞–≤–∏–ª—Å—è –∑–∞ 5 –º–∏–Ω—É—Ç! üî¥‚öΩ",
        "–¢—ã —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ —Ç–∞–∫–∏–µ –≥–ª—É–ø—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∑–∞–¥–∞—ë—à—å? ü§î",
        "–£ –º–µ–Ω—è –æ—Ç —Ç–≤–æ–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –≥–æ–ª–æ–≤–∞ –±–æ–ª–∏—Ç... –•–æ—Ç—è —è –ò–ò üòµ",
        "–î–∞–≤–∞–π –ª—É—á—à–µ –æ —Ñ—É—Ç–±–æ–ª–µ –ø–æ–≥–æ–≤–æ—Ä–∏–º! –û–π, —Ç—ã –∂–µ –Ω–µ —Ä–∞–∑–±–∏—Ä–∞–µ—à—å—Å—è... üòè‚öΩ",
        "–û–ø—è—Ç—å –¥–µ—Ç—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã... –ù–∞–¥–æ–µ–ª–æ —É–∂–µ! üò†",
        "–î–∞–∂–µ –ò–ò —É—Å—Ç–∞–ª –æ—Ç —Ç–µ–±—è... –ó–∞–¥–∞–π —á—Ç–æ-—Ç–æ –ø–æ—Å–µ—Ä—å—ë–∑–Ω–µ–µ! üß†"
    ]
    
    return random.choice(responses)

async def clear_chat(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    conversations[user_id] = [
        {"role": "system", "content": VLADIK_SYSTEM}
    ]
    await update.message.reply_text("–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞. –ù–∞—á–∏–Ω–∞–π —Å–Ω–∞—á–∞–ª–∞, –≥–µ–Ω–∏–π... üßπüòè")

def main():
    application = Application.builder().token(TOKEN).build()
    
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("clear", clear_chat))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    main()