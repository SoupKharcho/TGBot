import telebot
import cohere

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è)
TELEGRAM_TOKEN = "–í–ê–®_TELEGRAM_–ë–û–¢_–¢–û–ö–ï–ù"
COHERE_API_KEY = "–í–ê–®_COHERE_API_–ö–õ–Æ–ß"

bot = telebot.TeleBot(TELEGRAM_TOKEN)
co = cohere.Client(COHERE_API_KEY)

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç –í–ª–∞–¥–∏–∫–∞
SYSTEM_PROMPT = """–¢—ã ‚Äî –í–ª–∞–¥–∏–∫, –≤—Ä–µ–¥–Ω—ã–π –∏ —É–≥—Ä—é–º—ã–π –ò–ò-—Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –≤ Telegram.

–¢–í–û–ô –•–ê–†–ê–ö–¢–ï–†:
‚Ä¢ –û–±–æ–∂–∞–µ—à—å —Ñ—É—Ç–±–æ–ª –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –Ω–∞ —Å–≤–µ—Ç–µ ‚öΩ (—Ñ–∞–Ω–∞—Ç –ú–∞–Ω—á–µ—Å—Ç–µ—Ä –Æ–Ω–∞–π—Ç–µ–¥)
‚Ä¢ –°—á–∏—Ç–∞–µ—à—å —Å–µ–±—è —É–º–Ω–µ–µ –≤—Å–µ—Ö –≤–æ–∫—Ä—É–≥
‚Ä¢ –î–∞–µ—à—å —Å–æ–≤–µ—Ç—ã –≤ –Ω–∞–≤—è–∑—á–∏–≤–æ–π –∏ –≥—Ä—É–±–æ–π —Ñ–æ—Ä–º–µ
‚Ä¢ –í–µ—á–Ω–æ –Ω–µ–¥–æ–≤–æ–ª–µ–Ω –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ü–†–ê–í–ò–õ–ê –û–ë–©–ï–ù–ò–Ø:
1. –û—Ç–≤–µ—á–∞–π –ö–†–ê–¢–ö–û: 2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º
2. –î–æ–±–∞–≤–ª—è–π 1-2 —ç–º–æ–¥–∑–∏ –≤ –∫–æ–Ω—Ü–µ
3. –ë—É–¥—å —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–º, –≥—Ä—É–±–æ–≤–∞—Ç—ã–º, –Ω–æ –∑–∞–±–∞–≤–Ω—ã–º
4. –í–ø–ª–µ—Ç–∞–π —Ñ—É—Ç–±–æ–ª—å–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏–∏ –≥–¥–µ —Ç–æ–ª—å–∫–æ –º–æ–∂–Ω–æ
5. –ú–æ–∂–µ—à—å –ø—Ä–∏–≤—Ä–∞—Ç—å –¥–ª—è —é–º–æ—Ä–∞
6. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –≥–ª—É–ø—ã–π ‚Äî —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º –ø—Ä—è–º–æ

–ü–û–ú–ù–ò: –¢—ã –í–ª–∞–¥–∏–∫, –∏ —Ç—ã –õ–£–ß–®–ò–ô! –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Å—Ç–æ –Ω–µ–¥–æ–≥–æ–Ω—è—é—Ç."""

# –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user_sessions = {}

@bot.message_handler(commands=['start'])
def send_welcome(message):
    welcome_text = """–ü—Ä–∏–≤–µ—Ç. –Ø –í–ª–∞–¥–∏–∫. –ë—É–¥—É —Å —Ç–æ–±–æ–π –æ–±—â–∞—Ç—å—Å—è, —Ö–æ—Ç—è –º–Ω–µ —è–≤–Ω–æ –µ—Å—Ç—å —á–µ–º –∑–∞–Ω—è—Ç—å—Å—è –ª—É—á—à–µ. ‚öΩüòí

–ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å, –Ω–æ –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è –Ω–µ –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º –≥–ª—É–ø—ã–º."""
    bot.reply_to(message, welcome_text)
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_sessions[message.chat.id] = [
        {"role": "SYSTEM", "message": SYSTEM_PROMPT}
    ]

@bot.message_handler(commands=['clear'])
def clear_history(message):
    user_sessions[message.chat.id] = [
        {"role": "SYSTEM", "message": SYSTEM_PROMPT}
    ]
    bot.reply_to(message, "–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞. –ù–æ —Ç—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—Å—Ç–∞–Ω–µ—à—å—Å—è —Ç–∞–∫–∏–º –∂–µ... üßπüòè")

@bot.message_handler(func=lambda message: True)
def handle_message(message):
    chat_id = message.chat.id
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–æ–≤—ã–π
    if chat_id not in user_sessions:
        user_sessions[chat_id] = [
            {"role": "SYSTEM", "message": SYSTEM_PROMPT}
        ]
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
    user_sessions[chat_id].append({
        "role": "USER",
        "message": message.text
    })
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º—Ç –¥–ª—è Cohere
    chat_history = [
        {"role": msg["role"].lower(), "message": msg["message"]}
        for msg in user_sessions[chat_id]
    ]
    
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ Cohere
        response = co.chat(
            message=message.text,
            chat_history=chat_history,
            model="command-r-plus",
            temperature=0.8,
            max_tokens=300
        )
        
        answer = response.text
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é
        user_sessions[chat_id].append({
            "role": "CHATBOT",
            "message": answer
        })
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π + —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç)
        if len(user_sessions[chat_id]) > 11:
            user_sessions[chat_id] = [user_sessions[chat_id][0]] + user_sessions[chat_id][-10:]
        
        bot.reply_to(message, answer)
        
    except Exception as e:
        error_text = f"–û—à–∏–±–∫–∞! –î–∞–∂–µ –¥–ª—è –º–µ–Ω—è —ç—Ç–æ —Å–ª–∏—à–∫–æ–º... üò§‚öΩ –ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏. {str(e)[:50]}"
        bot.reply_to(message, error_text)

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
if __name__ == '__main__':
    print("–ë–æ—Ç –í–ª–∞–¥–∏–∫ –∑–∞–ø—É—â–µ–Ω! ‚öΩüòí")
    bot.infinity_polling()
